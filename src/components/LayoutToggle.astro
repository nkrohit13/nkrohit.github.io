---
interface Props {
    class?: string;
}

const { class: className } = Astro.props;
---

<div id="layout-toggle" class:list={['flex items-center space-x-1 p-1 bg-gray-100 rounded-lg', className]}>
    <button 
        type="button" 
        data-layout="grid" 
        class="p-2 rounded-md flex items-center justify-center text-gray-600 hover:bg-gray-100"
        aria-label="Grid view"
    >
        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z" />
        </svg>
    </button>
    <button 
        type="button" 
        data-layout="list" 
        class="p-2 rounded-md flex items-center justify-center text-white bg-gray-800"
        aria-label="List view"
    >
        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
        </svg>
    </button>
</div>

<script>
    // Type definitions for better type safety
    type LayoutType = 'grid' | 'list';
    
    document.addEventListener('astro:page-load', () => {
        const layoutToggle = document.getElementById('layout-toggle');
        const projectsContainer = document.getElementById('projects-container');
        
        if (!layoutToggle || !projectsContainer) {
            console.error('Could not find layout toggle or projects container');
            return;
        }
        
        // Get saved layout preference or default to 'grid'
        const savedLayout = (localStorage.getItem('projectsLayout') as LayoutType | null) || 'grid';
        console.log('Initial layout:', savedLayout);
        
        // Initialize the layout
        updateLayout(layoutToggle, projectsContainer, savedLayout);
        
        // Set up event listeners for layout toggle buttons
        layoutToggle.addEventListener('click', (e: Event) => {
            const target = (e.target as HTMLElement).closest?.('button');
            if (!target) return;
            
            const newLayout = target.getAttribute('data-layout') as LayoutType | null;
            if (!newLayout) return;
            
            console.log('Layout button clicked:', newLayout);
            updateLayout(layoutToggle, projectsContainer, newLayout);
            localStorage.setItem('projectsLayout', newLayout);
            console.log('Layout updated to:', newLayout);
        });
    });
    
    /**
     * Updates the layout of the projects container
     */
    function updateLayout(
        layoutToggle: HTMLElement,
        projectsContainer: HTMLElement,
        layout: LayoutType
    ): void {
        console.log('Updating layout to:', layout);
        
        // Update active button
        const buttons = layoutToggle.querySelectorAll<HTMLButtonElement>('button[data-layout]');
        buttons.forEach((btn) => {
            const btnLayout = btn.getAttribute('data-layout') as LayoutType | null;
            if (btnLayout === layout) {
                btn.classList.add('text-white', 'bg-gray-800');
                btn.classList.remove('text-gray-600', 'hover:bg-gray-100');
            } else {
                btn.classList.remove('text-white', 'bg-gray-800');
                btn.classList.add('text-gray-600', 'hover:bg-gray-100');
            }
        });
        
        // Update container classes
        if (layout === 'grid') {
            projectsContainer.className = 'grid grid-cols-1 md:grid-cols-2 gap-6';
            // Update project items for grid layout
            document.querySelectorAll('.project-item').forEach((item) => {
                item.className = 'project-item';
                const article = item.querySelector('article');
                if (article) {
                    article.classList.add('h-full');
                }
            });
        } else {
            projectsContainer.className = 'space-y-8';
            // Update project items for list layout
            document.querySelectorAll('.project-item').forEach((item) => {
                item.className = 'project-item';
                const article = item.querySelector('article');
                if (article) {
                    article.classList.remove('h-full');
                }
            });
        }
        
        // Force a reflow to ensure the layout updates
        void projectsContainer.offsetHeight;
    }
</script>
